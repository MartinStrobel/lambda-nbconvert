<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Jupyter AWS Lambda - Demo Page</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
    crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
    crossorigin="anonymous"></script>

  <style type="text/css">
    .code-container {
      font-family: 'Courier New', Courier, monospace;
    }
    .page-header {
      margin-bottom: 48px;
    }
    .hide {
      display: none;
    }
  </style>
</head>

<body>


  <div class="container-fluid">
    <div class="row">
      <div class="col col-md-12 page-header text-center">
        <h1 class="text-center">Jupyter AWS Lambda - Demo Page</h1>
      </div>
    </div>
    <div class="col-md-6  col-sm-12 col-12">
      <input class="custom-file-input hide" id="uploadNotebooks" multiple="" onchange="onNotebooksSelected(event)" type="file"> <br>
      <div class="btn-group" role="group" style="margin-bottom:8pt">
          <label style="margin-bottom:0pt" type="button" for="uploadNotebooks" class="btn  btn-success"><i class="fa fa-upload"></i> Add notebooks</label>
          <button type="button" class="btn btn-sm btn-primary" onclick="executeAllRows()"><i class="fa fa-refresh"></i> Run all
          </button>
          <button type="button" class="btn btn-sm btn-secondary" onclick="downloadAllRowResults()"><i class="fa fa-download"></i> Download all JSON results
          </button>
      </div>
      <br>
      <div class="input-group mb-3">
        <div class="input-group-prepend">
            <span class="input-group-text" id="inputGroupFileAddon01">Select text file(s): </span>
        </div>
        <div class="custom-file">
          <input class="custom-file-input" name="textfiles" multiple="" onchange="onTextFilesSelected(event)" type="file"> 
          <label class="custom-file-label" for="inputGroupFile01">Choose file</label>
        </div>
      </div>
    </div>
    <table id="mainTable" class="table table-hover table-sm">
    <tr>
      <thead>
        <th></th><th>File names</th><th>JSON results</th><th></th>
      </thead>
    </tr>
    </table>

    <!-- Modal to show notebooks -->
    <div id="notebookModal" class="modal fade" role="dialog">
      <div class="modal-dialog modal-lg">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Modal Header</h4>
        </div>
        <div class="modal-body">
          <div id="root" cols="80" rows="20" class="form-control code-container"></div>
          <textarea  id="ipynbInputTextField"  cols="80" rows="20" class="form-control code-container hide">
            </textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  </div>





  <script>
    //TODO: Figure out what this function actually does.
    function loadJSON(json) {
      window.problemJsonFile = json;
      const button = document.getElementById('NotebookPreview').nextSibling;
      button.click();
    }

    function encodeUploadedFiles(files) {
      console.log(files);
      for (var i = 0; i < files.length; i++) {
        var reader = new FileReader();
        const currentFile = files[i];
        reader.onload = function (readerEvt) {
          var binaryString = readerEvt.target.result;
          var fileInfo = {name: currentFile.name, content: btoa(binaryString) };
          window.UPLOADED_FILES.push(fileInfo);
        };
        reader.readAsBinaryString(files[i]);
      }
      $("#fileinfo").text("Selected files: " + files.length);
    }

    function onTextFilesSelected(event) {
      window.TEXT_FILES = [];
      files = event.target.files;
      for (var i = 0; i < files.length; i++) {
        var reader = new FileReader();
        const currentFile = files[i];
        reader.onload = function (readerEvt) {
          var binaryString = readerEvt.target.result;
          var fileInfo = {name: currentFile.name, content: btoa(binaryString) };
          window.TEXT_FILES.push(fileInfo);
        };
        reader.readAsBinaryString(files[i]);
      }
    }

   function onNotebooksSelected(event) {
      window.NOTEBOOKS = [];
      files = event.target.files;
      for (var i = 0; i < files.length; i++) {
        var reader = new FileReader();
        const currentFile = files[i];
        reader.onload = function (readerEvt) {
          var notebook = readerEvt.target.result;
          createNewTableRow(notebook,currentFile.name)
        };
        reader.readAsText(files[i]);
      }
    }

    function createNewTableRow(notebook,name){
      var table = document.getElementById("mainTable");
      var row = table.insertRow(-1);
      var buttonCell = row.insertCell(-1);
      buttonCell.innerHTML = "<div class='btn-group' role='group'>\
                              <button type='button' class='btn btn-sm btn-primary' onclick='executeRow(this)'><i class='fa fa-refresh'></i></button>\
                              <button type='button' class='btn btn-sm btn-info' data-toggle='modal' data-target='#notebookModal' onclick='showRow(this)' ><i class='fa fa-search'> </i></button> \
                              <button type='button' class='btn btn-sm btn-danger'  onclick='deleteRow(this)' ><i class='fa fa-trash-o'></i></button></div>"
      var nameCell = row.insertCell(-1);
      nameCell.innerHTML = JSON.stringify(name);
      nameCell.classList.add("name")
      row.setAttribute("notebook", notebook);
      row.insertCell(-1).classList.add("jsonResult") 
    }

    function deleteRow(e){
      e.closest("tr").remove();
    } 

    function executeRow(e){;
      var row = e.closest("tr");
      notebook = getNotebookForRow(row);
      var result = {};
      result['notebook'] = notebook;
      if (window.TEXT_FILES){
        result.files = {};
        for (var i = 0; i < window.UPLOADED_FILES.length; i++) {
          result.files[window.UPLOADED_FILES[i].name] = window.UPLOADED_FILES[i].content;
        }
      }
      postDataRow(result,row)
    } 

    function executeAllRows(e){
      $('#mainTable > tbody > tr').not(":first").each(function(){executeRow(this)});
    } 

    function showRow(e){
      var row = e.closest("tr");
      notebook = getNotebookForRow(row);
      modal = $("#notebookModal");
      modal.find(".code-container").value = JSON.stringify(notebook);
      loadJSON(notebook);
      modal.find(".modal-title")[0].innerHTML = $(row).find("td.name")[0].innerHTML;
    }

    function showRowResult(e){
      var row = e.closest("tr");
      notebook = getExecutedNotebookForRow(row);
      modal = $("#notebookModal");
      modal.find(".code-container").value = JSON.stringify(notebook);
      loadJSON(notebook);
      modal.find(".modal-title")[0].innerHTML = "<b> Executed: </b>".concat($(row).find("td.name")[0].innerHTML);
    }

    function getNotebookForRow(row){
      return JSON.parse(row.getAttribute("notebook"));
    }

    function getExecutedNotebookForRow(row){
      return JSON.parse(row.getAttribute("executedNotebook"));
    }

    function downloadExecutedNotebook(e) {
      var row = e.closest("tr");
      notebook = getExecutedNotebookForRow(row);
      name = $(row).find("td.name")[0].innerHTML
      download(name.substr(1,name.length-2), JSON.stringify(notebook)); //We use substring to get rid of the quotes
    }

    var jsonResult = "";
    function downloadAllRowResults(){
      jsonResult = "";
      $('#mainTable > tbody > tr').not(":first").each(function(){
        jsonResult = jsonResult + ($(this).find("td.jsonResult")[0].innerHTML).substr(2,$(this).find("td.jsonResult")[0].innerHTML.lastIndexOf("]")-2) + "\n";
        });
      download("jsonResult.txt", jsonResult);
    }

    var postDataRow = function (data,row) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onload = function () {
        if (xhr.status === 200) {
          var userInfo = JSON.parse(xhr.responseText);
          console.log(userInfo.duration, "seconds of execution time.")
          console.log(userInfo,"userInfo")
          row.setAttribute("executedNotebook", JSON.stringify(userInfo.ipynb));
          $(row).find("td.jsonResult")[0].innerHTML = parseJSONresult(JSON.stringify(userInfo.result));
          var resultbuttonCell = row.insertCell(-1);
          resultbuttonCell.innerHTML = "<div class='btn-group' role='group'>\
                              <button type='button' class='btn btn-sm btn-info'  data-toggle='modal' data-target='#notebookModal' onclick='showRowResult(this)' ><i class='fa fa-search'></i></button> \
                              <button type='button' class='btn btn-sm btn-secondary'  onclick='downloadExecutedNotebook(this)' ><i class='fa fa-download'> </i></button></div>"
        }
        else {
          console.log("Nope");
          document.getElementById("responseJSON").value = "Nope";
        }
      };
      xhr.send(JSON.stringify(data));
    }

    function parseJSONresult(result){
      return  result.replace(/\\"/g,"").replace(/{cvs: /,"").replace("}","").replace(/,\s/g,",");
    }

    /* 
        This function is being executed each time a new text file is selected.
        It puts contents of the file to the text area with the 'textField' ID.
        Text area contains a non-encoded version of the file.
     */
    function onTextFileSelected(event) {
      console.log('onTextFileSelected entered')
      var fileReader = new FileReader();
      fileReader.onload = textFileReaderLoadHandler;
      fileReader.readAsText(event.target.files[0]);
      window.UPLOADED_FILES = [];
      encodeUploadedFiles([event.target.files[0]]);
    }
    function textFileReaderLoadHandler(event) {
      //console.log(event.target.result);
      if (event.target.result) {
        var obj = event.target.result;
      }
      document.getElementById("textField").value = obj;
    }

    function download(filename, text) {
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }
    function downloadNotebook() {
      var fileContents = document.getElementById("responseJSON").value;
      download("notebook.ipynb", fileContents);
    }
    function downloadResults() {
      var fileContents = document.getElementById("resultJSON").value;
      download("results.json", fileContents);
    }

    function calculateNUSMatricNumber(id) {
      var matches = id.toUpperCase().match(/^A\d{7}|U\d{6,7}/);
      if (matches) {
        var match = matches[0];

        // Discard 3rd digit from U-prefixed NUSNET ID
        if (match[0] === 'U' && match.length === 8) {
            match = match.slice(0, 3) + match.slice(4);
        }

        var weights = {
            U: [0, 1, 3, 1, 2, 7],
            A: [1, 1, 1, 1, 1, 1]
        }[match[0]];

        for (var i = 0, sum = 0, digits = match.slice(-6); i < 6; i++) {
            sum += weights[i] * digits[i];
        }

        return match + 'YXWURNMLJHEAB' [sum % 13];
      }
    }

  </script>
  <script type="text/javascript"  src="https://s3-ap-southeast-1.amazonaws.com/alset-public/main-jupter-react-viewer.js"></script>

</body>

</html>